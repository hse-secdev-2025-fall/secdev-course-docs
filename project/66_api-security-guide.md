# API Security Guide - практические требования (2025)

## 1. Аутентификация
- Рекомендуется JWT (access + refresh) **или** session-based - зафиксируйте выбор в ADR.
- Access TTL: короткий (5-15 мин), Refresh TTL: умеренный (дни). Хранение refresh - безопасно.
- Пароли: хэш bcrypt/argon2, минимальные требования к сложности (регламент курса допускает разумный минимум).
- MFA - опционально (не обязательно для учебного MVP).

## 2. Авторизация и владение
- Проверять **владельца** ресурса для каждого `id` (см. NFR `SEC-AUTH-01`).
- Роли: `user` (своё), `admin` (всё). Прямой доступ по чужим `id` → **403**.
- IDOR-тесты обязательны (позитив/негатив).

## 3. Валидация и ошибки
- Схемы запросов/ответов (pydantic/marshmallow). Неверный вход → **400** с единым форматом:
```json
{ "code": "VALIDATION_ERROR", "message": "...", "details": {} }
```
- Ошибки аутентификации → **401**, авторизации → **403**, отсутствующий ресурс → **404**.
- Исключения не «просачиваются» в ответ (логируем, возвращаем `INTERNAL_ERROR` при необходимости).

## 4. Сеансы, CORS и заголовки
- CORS: по умолчанию - закрытый список источников. Не используйте `*` вместе с credentials.
- Заголовки безопасности (если фронт): `X-Content-Type-Options: nosniff`, `X-Frame-Options: DENY`, `Referrer-Policy: no-referrer`. CSP - при фронте.
- CSRF: если используете cookie-сессии - включите `SameSite` и защиту от CSRF.

## 5. Ограничение частоты и защита от брутфорса
- Rate limit на /auth/login и другие чувствительные эндпоинты.
- Лочить аккаунт после N неудачных попыток (с таймаутом), логировать события.

## 6. Пагинация/фильтрация/сортировка
- `limit`/`offset` с верхними границами; белый список полей для сортировки.

## 7. Аудит
- Логируйте значимые события (логин/логаут, создание/удаление ресурсов, попытки запрещённого доступа).
- Не логируйте пароли/токены/ПДн.
